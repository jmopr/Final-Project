<div class="col-md-10">
  <h2><%= @department.name %> Data</h2>
  <h3><%= "Data from #{@year}" %></h3>
</div>
  <div class="col-md-5">
  <%= form_tag '/departments/:id', method: :get, id: 'dept' do %>
      <%= select_tag "department", options_from_collection_for_select(@departments = Department.all, "id", "name", :selected => params[:id]) %>
      <%= select_tag "year", options_for_select((2012..2016).to_a.reverse.map{|y| [y,y]}, :selected => params[:year]) %>

      <%= submit_tag 'Search', class: 'search_button' %></span>
  <% end %>
  </div>
  <div class="col-md-4">
    <% job_titles = @department.job_titles.sort_by &:title %>
    <%= form_tag '/departments/:department_id/job_titles/:/job_title_id/year/:year', method: :get, id: 'job_route' do %>
      <%= select_tag "job_Title", options_from_collection_for_select(job_titles, "id", "title", :selected => params[:job_title_id]) %>
      <%= select_tag "year", options_for_select((2012..2016).to_a.reverse.map{|y| [y,y]}, :selected => params[:year]) %>
      <%= hidden_field_tag "department_id", @department.id %>
      <%= submit_tag 'Search', class: 'search_button' %>
    <% end %>
  </div>

<% women_salary = 0 %>
<% women_count = 0 %>
<% men_salary = 0 %>
<% men_count = 0 %>

<% @employees.each do |employee| %>
  <% if employee.gender == "female" %>
    <% women_salary += employee.salary %>
    <% women_count += 1 %>
  <% elsif employee.gender == "male" %>
    <% men_salary += employee.salary %>
    <% men_count += 1 %>
  <% end %>
<% end %><br>

<!-- General Data for the Department -->
<div class="col-md-12">
  <h4> General Salary Data in this Department </h4>
    <table class="table table-striped table-bordered text-center">
      <tr>
        <th class="text-center"> Gender </th>
        <th class="text-center"> Average Salary </th>
        <th class="text-center"> Total Workforce </th>
        <th class="text-center"> Workforce Percentage </th>
      </tr>
      <tr>
        <td>Male</td>
        <td><%= number_to_currency(men_salary / men_count) %></td>
        <td><%= number_with_delimiter(men_count) %></td>
        <td><%= number_to_percentage((men_count.to_f/(men_count + women_count))*100, precision: 2) %></td>
      </tr>
      <tr>
        <td>Female</td>
        <td><%= number_to_currency(women_salary / women_count) %></td>
        <td><%= number_with_delimiter(women_count) %></td>
        <td><%= number_to_percentage((women_count.to_f/(men_count + women_count))*100, precision: 2) %></td>
      </tr>
      <tr>
        <td>Department Totals</td>
        <td><%= number_to_currency((women_salary + men_salary) / (men_count + women_count)) %></td>
        <td><%= number_with_delimiter(men_count + women_count) %></td>
        <td><%= number_to_percentage(100, precision: 2) %></td>
      </tr>
  </table>
  <!-- Top Ten Salaries in the Department -->
  <h4> Top Ten Salaries in this Department </h4>
  <table class="table table-striped table-bordered text-center">
    <tr>
      <th class="text-center"> Name </th>
      <th class="text-center"> Gender </th>
      <th class="text-center"> Average Salary </th>
      <th class="text-center"> Department </th>
      <th class="text-center"> Job Title </th>
    </tr>
    <% @top_ten.each do |rich| %>
    <tr>
      <td><%= rich.name.split.map(&:capitalize).join(" ") %></td>
      <td><%= rich.gender.capitalize %></td>
      <td><%= number_to_currency(rich.salary) %></td>
      <td><%= @departments.find(rich.department_id).name %></td>
      <td><%= @job_titles.find(rich.job_title_id).title  %></td>
    </tr>
    <% end %>
  </table>
  <h4> Top Ten Men Salaries in this Department </h4>
  <table class="table table-striped table-bordered text-center">
    <tr>
      <th class="text-center"> Name </th>
      <th class="text-center"> Gender </th>
      <th class="text-center"> Average Salary </th>
      <th class="text-center"> Department </th>
      <th class="text-center"> Job Title </th>
    </tr>
    <% @top_ten_men.each do |rich_men| %>
    <tr>
      <td><%= rich_men.name.split.map(&:capitalize).join(" ") %></td>
      <td><%= rich_men.gender.capitalize %></td>
      <td><%= number_to_currency(rich_men.salary) %></td>
      <td><%= @departments.find(rich_men.department_id).name %></td>
      <td><%= @job_titles.find(rich_men.job_title_id).title %></td>
    </tr>
    <% end %>
  </table>
  <h4> Top Ten Women Salaries in this Department </h4>
  <table class="table table-striped table-bordered text-center">
    <tr>
      <th class="text-center"> Name </th>
      <th class="text-center"> Gender </th>
      <th class="text-center"> Average Salary </th>
      <th class="text-center"> Department </th>
      <th class="text-center"> Job Title </th>
    </tr>
    <% @top_ten_women.each do |rich_women| %>
    <tr>
      <td><%= rich_women.name.split.map(&:capitalize).join(" ") %></td>
      <td><%= rich_women.gender.capitalize %></td>
      <td><%= number_to_currency(rich_women.salary) %></td>
      <td><%= @departments.find(rich_women.department_id).name %></td>
      <td><%= @job_titles.find(rich_women.job_title_id).title %></td>
    </tr>
    <% end %>
  </table>
  <div id="department_chart_container" style="width: 1000px; height: 400px; margin: 0 auto"></div>
</div>

<script language="JavaScript">
$(document).ready(function() {
    var options = {
        chart: {
            renderTo: 'department_chart_container',
            type: 'column'
        },
        title: {
            text: "Average Salary Men/Women in <%= @department.name %>"
        },
        subtitle: {
            text: "Source: opendata.miamidade.gov"
        },
        colors: ['#0000FF', '#800080']
    };

    $.getJSON('/departments/<%=@department.id%>/year/<%=@year%>.json', function(data) {
        var men_data = [];
        var women_data = [];
        var years = [];
        for(key in data){
          men_data.push(parseFloat(data[key].men));
          women_data.push(parseFloat(data[key].women));
          years.push(data[key].year);
        }
        options.yAxis = {
          title: {
              text: "Average Salary ($)"
          }
        }
        options.xAxis = {
          categories: years,
          title: {
              text: "Year"
          }
        }
        options.series = [
          {
            name: 'Men',
            data: men_data
          },
          {
            name: 'Women',
            data: women_data
          }
        ]
        var chart = new Highcharts.Chart(options);
    });
});
</script>

<p class="bottom_links"> <%= link_to 'Home Page', employees_home_path %> |
<%= link_to 'Salary Information for the County', employees_index_path %> </p>
